using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Globalization;
using System.Linq;
using System.Threading;
using System.Web;
using System.Web.Mvc;
using System.Web.Optimization;
using System.Web.Routing;
using TraahvIndividual.Models;

namespace TraahvIndividual
{
    public class MvcApplication : System.Web.HttpApplication
    {
        protected void Application_Start()
        {
            Database.SetInitializer(new TrahvidDbInitializer());
            AreaRegistration.RegisterAllAreas();
            FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);
            RouteConfig.RegisterRoutes(RouteTable.Routes);
            BundleConfig.RegisterBundles(BundleTable.Bundles);
            Database.SetInitializer<TrahvidContext>(new DropCreateDatabaseIfModelChanges<TrahvidContext>());
        }
        protected void Application_BeginRequest()
        {
            // ???????? ???????? lang ?? URL, ????????: ?lang=ru
            var culture = HttpContext.Current.Request.QueryString["lang"];

            // ???? ???????? lang ??????????, ????????????? ????????? ????????
            if (!string.IsNullOrEmpty(culture))
            {
                try
                {
                    // ????????????? ???????? ?? ?????? ??????????? ?????????
                    CultureInfo newCulture = new CultureInfo(culture);
                    Thread.CurrentThread.CurrentCulture = newCulture;
                    Thread.CurrentThread.CurrentUICulture = newCulture;

                    // ????????? ????????? ???????? ? HttpContext, ????? ?????????? ?? ??????
                    HttpContext.Current.Items["lang"] = culture;
                }
                catch (CultureNotFoundException)
                {
                    // ???? ???????? ?? ???????, ????? ?????????? ?????? ??? ?????? ???????? ?? ?????????
                    SetDefaultCulture();
                }
            }
            else
            {
                // ???? ???????? lang ???????????, ????????????? ???????? ?? ?????????
                SetDefaultCulture();
            }
        }

        // ????? ??? ????????? ???????? ?? ????????? (????????, ??????????)
        private void SetDefaultCulture()
        {
            string defaultCulture = "est"; // ???????? ?? ?????????
            CultureInfo newCulture = new CultureInfo(defaultCulture);
            Thread.CurrentThread.CurrentCulture = newCulture;
            Thread.CurrentThread.CurrentUICulture = newCulture;

            // ????????? ???????? ?? ????????? ? HttpContext
            HttpContext.Current.Items["lang"] = defaultCulture;
        }
    }
}
